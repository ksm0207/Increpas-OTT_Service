<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="review">

	<select id="viewContent" parameterType="int" resultType="com.ott.platform.vo.PlatFormVO">
		SELECT * FROM OTT_SERVICE
		WHERE OTT_IDX = #{ott_idx}
	</select>

	<insert id="add_review" parameterType="com.ott.review.vo.ReviewVO">
		INSERT INTO OTT_REVIEW(RV_IDX, OTT_IDX, U_IDX, CONTENT, RATING, IS_GOOD, IS_NOT, U_ID, R_DATE)
		VALUES(OTT_REVIEW_BBS_SEQ.NEXTVAL, #{ott_idx}, #{u_idx}, #{content}, #{rating}, 1, 1, #{u_id}, sysdate)
	</insert>
	
	
	<select id="get_u_idx" resultType="com.ott.user.vo.UserVO" parameterType="com.ott.user.vo.UserVO">
		SELECT U_IDX 
		FROM OTT_USER
		WHERE U_ID = #{u_id}
	</select>
	
	
	
	
	
	<resultMap id="review_map" type="com.ott.review.vo.ReviewVO">
		<id property="rv_idx" column="rv_idx"/>
		<!-- 원글 하나에 여러 개의 댓글들이 존재할 수 있으므로
			집합구조를 일대 다관계에 맞는 collection을 선언한다. -->
	</resultMap>
	
	
	<select id="getReview" resultMap="review_map" parameterType="Map">
		SELECT * FROM (
			SELECT rownum r_num,a.* FROM (
				SELECT * FROM OTT_REVIEW
				WHERE ott_idx = #{ott_idx}
				ORDER BY rv_idx DESC
			) a 
		) WHERE r_num BETWEEN #{begin} AND #{end}
	</select>
	
	<select id="review_count" resultType="int" parameterType="int">
		SELECT COUNT(*) FROM OTT_REVIEW
		WHERE OTT_IDX = #{ott_idx}
	</select>
	
	<select id="rating" resultType="double" parameterType="int">
		SELECT ROUND(AVG(RATING),2) FROM OTT_REVIEW
		WHERE OTT_IDX = #{ott_idx}
	</select>
	
	

</mapper>